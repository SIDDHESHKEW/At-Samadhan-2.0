{% extends "NeuroBoostApp/base.html" %}

{% block title %}Focus Dashboard{% endblock %}

{% block content %}
<!-- Note: All Tailwind and base CSS is now in base.html. Only specific component styles remain here. -->
<style>
    .completed {
        text-decoration: line-through;
        color: #94A3B8; /* Slate-400 */
    }
    .glowing-streak {
        /* Keyframes are now implicitly in the base CSS if you transferred them, 
           but since they were in the original body style, we'll keep the class reference. */
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.7); /* Custom static glow for quick demo */
    }
</style>

<!-- FIX: Wrapper for wide layout. This sets the maximum width to 6xl (1152px) and centers it. 
     This allows your grid layouts (4-column and 3-column) to display correctly. -->
<div class="max-w-6xl mx-auto px-4">
    <!-- MAIN DASHBOARD CONTENT -->
    <header class="mb-8 text-center">
        <h1 class="text-4xl font-extrabold text-white">Focus Dashboard</h1>
        <p class="text-slate-400">Welcome back, {{ user.username|default:"Guest" }}! Time to crush those goals.</p>
    </header>

    {% if user_profile %}
    <!-- Stat Cards & XP Progress -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        
        <!-- XP & Level Card (Uses Django logic) -->
        <div class="bg-slate-800 p-5 rounded-xl shadow-lg border-t-4 border-violet-500">
            <h2 class="text-lg font-semibold text-violet-400">Level</h2>
            <p id="current-level" class="text-5xl font-extrabold text-white mt-1">{{ user_profile.level }}</p>
            <div class="mt-4">
                <div class="flex justify-between text-sm text-slate-400">
                    <!-- XP displayed correctly, assuming level 1 = 100 XP max -->
                    <span>XP: <span id="current-xp">{{ user_profile.xp }}</span> / {{ user_profile.level|add:1|default:1 }}00</span>
                    <span id="xp-needed" class="text-xs text-violet-300">{{ xp_to_next_level }} to next level</span>
                </div>
                <!-- XP Progress Bar (Using Django calculation logic) -->
                {% with progress_percent=user_profile.xp|stringformat:"d"|slice:"-2:"|default:"0" %}
                <div class="w-full bg-slate-700 rounded-full h-2.5 mt-1">
                    <div id="xp-bar" class="bg-violet-500 h-2.5 rounded-full transition-all duration-500" 
                            style="width: {{ progress_percent }}%">
                    </div>
                </div>
                {% endwith %}
            </div>
        </div>

        <!-- Streak Card (Uses Django logic) -->
        <div id="streak-card" class="bg-slate-800 p-5 rounded-xl shadow-lg border-t-4 border-emerald-500 {% if user_profile.current_streak > 0 %}glowing-streak{% endif %}">
            <h2 class="text-lg font-semibold text-emerald-400">Consistency Streak</h2>
            <p id="current-streak" class="text-5xl font-extrabold text-white mt-1">{{ user_profile.current_streak }}</p>
            <p class="text-slate-400 mt-2">Days Focused</p>
        </div>

        <!-- Focus Time Card (Placeholder for Django/Session data) -->
        <div class="bg-slate-800 p-5 rounded-xl shadow-lg border-t-4 border-sky-500">
            <h2 class="text-lg font-semibold text-sky-400">Today's Focus</h2>
            <p id="daily-focus" class="text-5xl font-extrabold text-white mt-1">{{ total_focus_time_today|default:"0h 0m" }}</p>
            <p class="text-slate-400 mt-2">Goal: 2 hours</p>
        </div>

        <!-- Tasks Completed Card (Placeholder for Django count) -->
        <div class="bg-slate-800 p-5 rounded-xl shadow-lg border-t-4 border-amber-500">
            <h2 class="text-lg font-semibold text-amber-400">Tasks Completed</h2>
            <p id="tasks-completed" class="text-5xl font-extrabold text-white mt-1">{{ completed_tasks_count|default:0 }}/{{ total_tasks_count|default:0 }}</p>
            <p class="text-slate-400 mt-2">Tasks Done Today</p>
        </div>

    </section>
    {% endif %}

    <!-- Main Content Grid: To-Do List & Progress Tracker -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- To-Do List (Column 1 & 2) -->
        <div class="lg:col-span-2 bg-slate-800 p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-4 border-b border-slate-700 pb-2">To-Do List</h2>

            <!-- Add Task Form (Uses Django POST structure) -->
            <!-- NOTE: Using temp URL 'add_task'. Must be created in urls.py and views.py. -->
            <form method="POST" action="{% url 'home' %}" id="add-task-form" class="mb-6 flex flex-col md:flex-row gap-3">
                {% csrf_token %}
                <input type="text" name="title" placeholder="What's the task? (e.g., Study Django Models)" required 
                           class="flex-grow p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500">
                
                <select name="category" id="task-category" 
                           class="p-3 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-violet-500 w-full md:w-32">
                    <!-- Use Django category choices if available -->
                    {% for key, value in Task_CATEGORY_CHOICES %}
                        <option value="{{ key }}" {% if key == 'Study' %}selected{% endif %}>{{ value }}</option>
                    {% empty %}
                        <option value="Study">Study</option>
                        <option value="General">General</option>
                    {% endfor %}
                </select>
                <!-- Deadline field is retained -->
                <input type="date" name="deadline" id="task-deadline" 
                           class="p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500 w-full md:w-40">

                <button type="submit" class="p-3 bg-violet-600 hover:bg-violet-700 text-white font-semibold rounded-lg transition duration-200 w-full md:w-28">
                    Add Task
                </button>
            </form>

            <!-- Task Filters (Fixed: Now correctly shows counts from Django context, assumes these vars are passed) -->
            <div class="flex space-x-3 mb-4 text-sm border-b border-slate-700 pb-2">
                <!-- Note: In Django, these counts (e.g., total_tasks_count) must be calculated in the view and passed to the template. -->
                <a href="?filter=all" class="py-1 px-3 rounded-full bg-violet-700 text-white">All ({{ total_tasks_count|default:0 }})</a>
                <a href="?filter=study" class="py-1 px-3 rounded-full bg-slate-700 hover:bg-slate-600 text-slate-300">Study ({{ study_tasks_count|default:0 }})</a>
                <a href="?filter=general" class="py-1 px-3 rounded-full bg-slate-700 hover:bg-slate-600 text-slate-300">General ({{ general_tasks_count|default:0 }})</a>
                <a href="?filter=pending" class="py-1 px-3 rounded-full bg-slate-700 hover:bg-slate-600 text-slate-300">Pending ({{ incomplete_tasks_count|default:0 }})</a>
            </div>

            <!-- Task List Container (Renders live data from Django) -->
            <div id="task-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                {% for task in tasks %}
                <div class="flex items-center justify-between bg-slate-700 p-4 rounded-xl shadow-md transition-all duration-300 hover:shadow-xl hover:bg-slate-600">
                    <div class="flex-grow">
                        <span class="text-lg {% if task.completed %}completed{% endif %}">
                            {{ task.title }} 
                        </span>
                        <span class="text-xs font-mono py-0.5 px-2 ml-2 rounded text-violet-300 bg-violet-900/50">
                            {{ task.category }} (+{{ task.xp_points }} XP)
                        </span>
                    </div>

                    <form method="POST" action="{% url 'toggle_complete' task.id %}" class="ml-4 flex items-center space-x-2">
                        {% csrf_token %}
                        <!-- Toggle Button -->
                        <button
                            type="submit"
                            class="text-white font-medium py-2 px-4 rounded-full transition-colors duration-300
                            {% if task.completed %}
                                bg-emerald-600 hover:bg-emerald-700
                            {% else %}
                                bg-violet-600 hover:bg-violet-700
                            {% endif %}
                            "
                        >
                            {% if task.completed %}
                                Undo
                            {% else %}
                                Done
                            {% endif %}
                        </button>
                    </form>
                    
                    <!-- Delete Button -->
                    <form method="POST" action="{% url 'delete_task' task.id %}" onsubmit="return confirmDeletion()">
                        {% csrf_token %}
                        <button type="submit" class="text-red-400 hover:text-red-500 transition duration-150 p-1 rounded-full ml-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.728-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </form>

                </div>
                {% empty %}
                    <p class="text-center text-gray-500 italic p-4">You're all caught up! Add a new task above.</p>
                {% endfor %}
            </div>
        </div>

        <!-- Focus Goals (Column 3) -->
        <div class="lg:col-span-1 bg-slate-800 p-6 rounded-xl shadow-2xl">
            <h2 class="text-xl font-bold text-white mb-4 border-b border-slate-700 pb-2">Focus Goals</h2>
            <div class="bg-slate-700 p-4 rounded-lg">
                <p class="text-slate-300">Next Milestone:</p>
                <p class="text-lg font-semibold text-violet-400">Reach Level {{ user_profile.level|add:1 }}</p>
                <p class="text-slate-300 mt-2">XP Progress:</p>
                <div class="w-full bg-slate-800 rounded-full h-2.5 mt-1">
                    <div class="bg-violet-500 h-2.5 rounded-full" 
                         style="width: {{ user_profile.xp|floatformat:0|default:0 }}%">
                    </div>
                </div>
                <p class="text-xs text-slate-400 mt-1">{{ user_profile.xp }} / {{ user_profile.level|add:1 }}00 XP</p>
            </div>
        </div>

    </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // --- GENERAL UX IMPROVEMENTS (Local to Dashboard) ---

    // Simple function to replace 'alert()' for deletion confirmation
    function confirmDeletion() {
        // NOTE: Since we cannot use alert(), this is a placeholder. 
        // In a real Django app, the view would handle the success/fail
        console.log("Task deletion attempted. Redirecting to Django view.");

        // Temporarily use a conversational message box for UX clarity
        showTemporaryMessage("Deleting task...", 'red');
        return true; // Allows form submission
    }

    // Simple Message Box to replace 'alert()'
    function showTemporaryMessage(message, color) {
        const messageBox = document.createElement('div');
        messageBox.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-3 rounded-lg shadow-xl text-white z-[99] 
                                 bg-${color}-600 transition-all duration-300 opacity-0`;
        messageBox.textContent = message;
        document.body.appendChild(messageBox);
        
        // Fade in
        setTimeout(() => messageBox.style.opacity = 1, 10);

        // Fade out and remove
        setTimeout(() => {
            messageBox.style.opacity = 0;
            messageBox.addEventListener('transitionend', () => messageBox.remove());
        }, 3000);
    }
    
    // Task management functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Any initialization code for the dashboard can go here
    });
</script>
{% endblock %}
